<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Pickleball Instant Replay</n></head>
<body class="bg-gray-900 text-white">
<div class="container mx-auto p-4">
  <h1 class="text-2xl mb-4">üèì Pickleball Instant Replay</h1>
  <label for="videoUpload" class="block mb-2">üìÅ Upload Pickleball Game (MP4):</label>
  <input type="file" id="videoUpload" accept="video/mp4" class="mb-4 block" />
  <button id="processBtn" class="bg-blue-600 px-4 py-2 rounded mb-4" disabled>Loading models...</button>
  <div id="highlights" class="space-y-4"></div>
</div>
<canvas id="videoCanvas" class="hidden"></canvas>

<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@3.14.0/dist/tf.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/posenet@2.2.1/dist/posenet.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@ffmpeg/ffmpeg@0.10.0/dist/ffmpeg.min.js"></script>

<script>
  const { createFFmpeg, fetchFile } = FFmpeg;
  // Specify corePath so FFmpeg can load properly
  const ffmpeg = createFFmpeg({ log: true, corePath: 'https://cdn.jsdelivr.net/npm/@ffmpeg/core@0.10.0/dist/ffmpeg-core.js' });
  let posenetModel;
  const uploadInput = document.getElementById('videoUpload');
  const processBtn = document.getElementById('processBtn');
  const highlightsContainer = document.getElementById('highlights');
  const canvas = document.getElementById('videoCanvas');
  const ctx = canvas.getContext('2d');

  async function loadModels() {
    try {
      processBtn.textContent = 'Loading PoseNet...';
      posenetModel = await posenet.load();
      processBtn.textContent = 'Loading FFmpeg...';
      await ffmpeg.load();
      processBtn.textContent = 'Process Highlights';
      processBtn.disabled = false;
    } catch (err) {
      console.error('Error loading models:', err);
      processBtn.textContent = 'Error loading models';
    }
  }

  loadModels();

  async function analyzeVideo(file) {
    return new Promise((resolve) => {
      const video = document.createElement('video');
      video.src = URL.createObjectURL(file);
      video.crossOrigin = 'anonymous';
      video.onloadedmetadata = async () => {
        const duration = video.duration;
        const sampleRate = 0.5;
        const motionThreshold = 100;
        let prevKeypoints = null;
        const segments = [];
        let segStart = null;
        for (let t = 0; t < duration; t += sampleRate) {
          video.currentTime = t;
          await new Promise(r => video.onseeked = r);
          canvas.width = video.videoWidth;
          canvas.height = video.videoHeight;
          ctx.drawImage(video, 0, 0);
          const pose = await posenetModel.estimateSinglePose(canvas, { flipHorizontal: false });
          const keypoints = pose.keypoints.map(k => k.position);
          if (prevKeypoints) {
            let motion = 0;
            for (let i = 0; i < keypoints.length; i++) {
              const dx = keypoints[i].x - prevKeypoints[i].x;
              const dy = keypoints[i].y - prevKeypoints[i].y;
              motion += Math.hypot(dx, dy);
            }
            if (motion > motionThreshold) {
              if (segStart === null) segStart = t;
            } else if (segStart !== null) {
              segments.push({ start: segStart, end: t });
              segStart = null;
            }
          }
          prevKeypoints = keypoints;
        }
        if (segStart !== null) segments.push({ start: segStart, end: duration });
        resolve(segments.filter(s => (s.end - s.start) > 2));
      };
    });
  }

  processBtn.addEventListener('click', async () => {
    const file = uploadInput.files[0];
    if (!file) return alert('Upload a video first.');
    highlightsContainer.innerHTML = '<p class="text-center">Analyzing video... please wait.</p>';
    await ffmpeg.FS('writeFile', 'input.mp4', await fetchFile(file));
    const segments = await analyzeVideo(file);
    highlightsContainer.innerHTML = '';
    for (let i = 0; i < segments.length; i++) {
      const { start, end } = segments[i];
      const outName = `clip_${i}.mp4`;
      await ffmpeg.run('-i', 'input.mp4', '-ss', `${start}`, '-to', `${end}`, '-c', 'copy', outName);
      const data = ffmpeg.FS('readFile', outName);
      const url = URL.createObjectURL(new Blob([data.buffer], { type: 'video/mp4' }));
      const div = document.createElement('div');
      div.className = 'bg-gray-800 p-4 rounded';
      div.innerHTML = `
        <p class="font-semibold">üî• Rally Clip ${i+1}: ${start.toFixed(1)}s‚Äì${end.toFixed(1)}s</p>
        <video controls class="w-full mt-2 bg-black"><source src="${url}" type="video/mp4"></video>
        <button onclick="shareHighlight('Rally Clip ${i+1}')" class="mt-2 bg-green-600 px-3 py-1 rounded">Share</button>
      `;
      highlightsContainer.appendChild(div);
    }
    alert('Highlights ready!');
  });

  function shareHighlight(title) {
    if (navigator.share) navigator.share({ title, text: 'Check out my pickleball rally!', url: window.location.href });
    else alert('Web share not supported');
  }
</script>
</body>
</html>

