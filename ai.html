<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Pickleball Replay WebApp</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/@ffmpeg/ffmpeg@0.10.0/dist/ffmpeg.min.js"></script>
</head>
<body class="bg-gray-900 text-white">
<div class="container mx-auto p-4">
  <h1 class="text-2xl mb-4">üèì Pickleball Instant Replay</h1>

  <!-- Upload Video -->
  <label for="videoUpload" class="block mb-2">üìÅ Select Pickleball Game Video (MP4):</label>
  <input type="file" id="videoUpload" accept="video/mp4" class="mb-4 block" />

  <!-- Process Button -->
  <button id="processBtn" class="bg-blue-600 px-4 py-2 rounded mb-4">Process Highlights</button>

  <!-- Highlights -->
  <div id="highlights" class="space-y-4"></div>
</div>

<script>
  const { createFFmpeg, fetchFile } = FFmpeg;
  const ffmpeg = createFFmpeg({ log: true });
  const uploadInput = document.getElementById('videoUpload');
  const highlightsContainer = document.getElementById('highlights');

  // Placeholder rally detection: replace with AI logic
  async function analyzeVideo(file) {
    // TODO: Implement actual AI rally detection (audio/visual analysis)
    // Currently returns sample segments in seconds
    return [
      { start: 10, end: 20 },
      { start: 35, end: 45 },
      { start: 60, end: 70 }
    ];
  }

  async function loadFFmpeg() {
    if (!ffmpeg.isLoaded()) {
      await ffmpeg.load();
    }
  }

  document.getElementById('processBtn').addEventListener('click', async () => {
    const file = uploadInput.files[0];
    if (!file) {
      alert('Please upload a video before processing highlights.');
      return;
    }

    highlightsContainer.innerHTML = '<p>Loading FFmpeg and analyzing video... ‚è≥</p>';
    await loadFFmpeg();

    // Write file to FFmpeg FS
    ffmpeg.FS('writeFile', 'input.mp4', await fetchFile(file));

    // Detect rally segments
    const segments = await analyzeVideo(file);

    highlightsContainer.innerHTML = '';

    for (let i = 0; i < segments.length; i++) {
      const { start, end } = segments[i];
      const outputName = `clip_${i}.mp4`;

      // Extract clip
      await ffmpeg.run(
        '-i', 'input.mp4',
        '-ss', start.toString(),
        '-to', end.toString(),
        '-c', 'copy',
        outputName
      );

      // Read and display clip
      const data = ffmpeg.FS('readFile', outputName);
      const blob = new Blob([data.buffer], { type: 'video/mp4' });
      const url = URL.createObjectURL(blob);

      const div = document.createElement('div');
      div.className = 'bg-gray-800 p-4 rounded';
      div.innerHTML = `
        <p class="font-semibold">üî• Rally Clip ${i + 1} (from ${start}s to ${end}s)</p>
        <video controls class="w-full h-auto mt-2 bg-black">
          <source src="${url}" type="video/mp4">
          Your browser does not support the video tag.
        </video>
        <button onclick="shareHighlight('Rally Clip ${i + 1}')" class="mt-2 bg-green-600 px-3 py-1 rounded">Share</button>
      `;
      highlightsContainer.appendChild(div);
    }

    alert('Highlights ready!');
  });

  function shareHighlight(title) {
    if (navigator.share) {
      navigator.share({
        title: title,
        text: 'Check out my pickleball rally!',
        url: window.location.href
      }).catch(console.error);
    } else {
      alert('Sharing is not supported by your browser.');
    }
  }
</script>

</body>
</html>
